# 一致性哈希

## 一、前言
1. 大多数网站，都是使用**服务器集群**来对外提供服务，此时如何分配客户端的请求呢？这个问题就是**负载均衡问题**，不同的负载均衡算法，采用了不同的分配策略，决定了如何将请求分配到不同的**服务器节点**（以后简称为**节点**）上
2. 常见的**负载均衡算法**有：<font color=Blue> 轮询、随机、加权轮询、加权随机、**一致性哈希**、最少连接数</font>等
3. 不管是轮询还是加权轮询，需要保证每个服务器节点存储的数据是一样的，这导致该算法无法应对**分布式系统（数据分片的系统）**。因为分布式系统每个节点存储的数据是不同的
4. <font color=Blue> 一个分布式 KV（key-value） 缓存系统，某个 key 应该到哪个或者哪些节点上获得，应该是确定的。</font>所以，要想一个能应对分布式系统的负载均衡算法

## 二、哈希算法应对负载均衡，以及存在的问题
- **为什么**可以：对同一个关键字进行哈希计算，每次计算都是相同的值。这样就可以将某个 key 确定到一个节点了，可以满足分布式系统的负载均衡需求

- 最简单的**实现**：最简单的做法就是进行取模运算，比如分布式系统中有 3 个节点
  - 定位节点算法：`hash(key) % 3`

- 存在的**问题**：<font color=Blue>如果节点数量发生了变化，也就是在对系统做扩容或者缩容时，必须迁移改变了映射关系的数据</font>，否则会出现查询不到数据的问题。迁移当然可以，但是当总数据条数为 M ，在面对节点数量变化时，最坏情况下所有数据都需要迁移，<font color=Blue>所以它的数据迁移规模是 O(M) </font>

## 三、一致性哈希应对负载均衡，以及存在的问题
- **一致性哈希**算法就**很好地解决了**分布式系统在扩容或者缩容时，发生过多的**数据迁移**的问题。
- **解决方案**：<font color=Blue>使用**哈希环**！！！</font>
  - 什么是哈希环？哈希环像钟表一样，钟表上有60个刻度对应不同分钟，哈希环上的刻度是 $0 \sim 2^{32}-1$ ，每个刻度对应一个哈希值
  - 哈希环的映射是对**节点**与**数据**的映射。
    - 对每个节点（例如节点的IP）计算哈希值，映射到哈希环上
    - 对节点存储的数据进行哈希映射，映射到哈希环上
  - 如何根据哈希环找到数据对应的节点？
    - 对数据进行哈希映射后，根据的得到的哈希值，**顺时针**找到哈希环上离它最近的节点，就是该数据被存储的节点
  - 哈希环相较于直接取模，<font color=Blue>解决了什么问题？</font>
    - 直接取模在节点变化后，将可能产生所有数据的迁移
    - 哈希环在节点变化后，只会影响**被取消或被添加的节点**顺时针方向的下一个节点的数据存储。将数据迁移复杂度大幅下降。
- 但其实**哈希环本身没有解决负载均衡**问题，毕竟会存在节点映射的哈希值只集中在哈希环某些地方，导致数据倾斜的情况。这该如何是好？
  - **解决方案**：<font color=Blue>虚拟节点</font>。如果节点足够多，那么从经验上来思考，哈希环上就很难出现节点只集中在一侧的问题。但是受硬件成本制约，<font color=Blue>不可能有那麽多物理节点，所以最先想到的就是用一对多的映射，将一个物理节点映射成 n 个虚拟节点</font>
    - 虚拟节点：将一个节点映射为多个节点，将虚拟节点映射到哈希环上
    - 数据根据哈希值在哈希环上找到对应的虚拟节点，该虚拟节点将唯一确定数据存储的物理节点
  - 采用虚拟节点的**好处**
    - 首先，解决了负载均衡问题
    - 其次，<font color=Blue>提高系统的稳定性</font>：当某一物理节点被撤销或被添加时，只有该节点的数据才需要被迁移（哈希环特性）；除此之外，由于该物理节点对应的诸多虚拟节点在哈希环上的映射的诸多后继虚拟节点大概率**不属于同一个物理节点**，<font color=Blue>当节点变化时，会有不同的节点共同分担系统的变化，因此稳定性更高</font>









