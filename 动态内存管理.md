# 动态内存管理
本模块会介绍`malloc`、`free`、`new`、`delete`等内存动态分配函数的底层原理与实现

## `malloc`与`free`
### `malloc`
- `malloc()`函数是**库函数**，并非系统调用
```C
void* malloc(size_t size);
```
- 其分配的是**虚拟内存**，在分配完成之后不会直接映射物理内存（不用就不会）
- 内存分配模式（依大小分为两种）：
  - size < 128KB 时，如果内存池中有相应内存空间，直接分配返回；如果没有，进行BRK系统调用，从堆上分配空间（地址从小到大分配）
  - size > 128KB 时，使用`mmap`系统调用，从文件映射区（地址从高到低分配，与堆相反）获取空间（文件映射区也会存储动态链接库的映射地址）
### `free`
- `free`释放`malloc()`申请的空间时，如何知道该释放多大的空间？
  - 当调用`malloc(size)`时，内存分配器不仅返回用户请求的size字节内存，还会在内存块的头部（或尾部） 存储一个**元数据块**（Metadata）
    - 元数据通常包含：分配的内存块大小\对齐信息\调试信息（如调试模式下）\用于内存块管理的指针（如链表指针）
  - 当调用`free(ptr)`时，分配器会通过指针ptr向前**回溯到元数据块的起始位置**，直接读取内存块大小和其他管理信息。
  
- `free`释放`malloc()`申请的内存后，内存还在吗？
